<%-include('./style')%>
<%- include('../partials/datatable-css')%>
    <div class="card-body">
        <div class="row">

            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="nav-user-tab" data-bs-toggle="tab" data-bs-target="#nav-user"
                        type="button" role="tab" aria-controls="nav-home" aria-selected="true">User Management</button>
                    <button class="nav-link" id="nav-role-tab" data-bs-toggle="tab" data-bs-target="#nav-role"
                        type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Role
                        Management</button>
                </div>
            </nav>
            <hr>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-user" role="tabpanel" aria-labelledby="nav-user-tab">
                    <div class="container-fluid">
                        <button type="button" class="btn btn-primary m-1">Create User</button>
                    </div>
                    <div class="row p-4">
                        <table class="table table-striped table-bordered table-hover visible" id="userTable">
                            <thead>
                                <tr>
                                    <th>Sr No</th>
                                    <th>Name</th>
                                    <th>Email address</th>
                                    <th>Created By</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="nav-role" role="tabpanel" aria-labelledby="nav-role-tab">
                    <div class="container-fluid">
                        <button type="button" class="btn btn-primary m-1">Create Role</button>
                    </div>
                    <div class="row">
                        <table class="table table-striped table-bordered table-hover visible" id="roleTable">
                            <thead>
                                <tr>
                                    <th>Sr No</th>
                                    <th>Role name</th>
                                    <th>Created By</th>
                                    <th>Total Users</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(()=>{
            loadTable()
        })
        const token = localStorage.getItem('user')
        const user = JSON.parse(token)
        
        const loadTable = () => {
            $('#userTable').DataTable({
            destroy: true,
            search: true,
            processing: true,
            filter: true,
            orderMulti: false,
            serverSide: true,
            columnDefs: [{ 'orderable': false, 'targets': 0 }], // hide sort icon on header of first column
            aaSorting: [[3, 'desc']],
            responsive: true,
            ajax: {
                url:  `${config.SERVER_URL}${config.URLS.USER_LIST}`,
                type: "GET",
                contentType: 'application/json',
                datatype: "json",
                headers:{
                    authorization: `Bearer ${user.token}`
                }
            },
            columns:[
                {
                    orderable: false, targets: -1,
                        render: function (data, type, row, meta) {
                            return meta.row + meta.settings._iDisplayStart + 1;
                        }
                },
                { data: 'name' },
                { data: 'email'},
                {
                    render: (data, type, row, meta)=>{
                        return row.createdBy ? row?.createdBy: 'Super Admin'
                    }
                },
                {
                    render: (data, type, row, meta)=>{
                        return row.roleDetails.length > 0 ? row?.roleDetails[0]?.roleName : 'Role not assigned'
                    }
                },
                {
            data: '_id', orderable: false, targets: -1,
            render: (data, type, row, meta) => {
              let title = ""
              let modal = ""
              let _Class = ""
              if(row.isActive){
                 title = "Active"
                 modal = "#Deactivate_Modal"
                 _Class = "fa fa-user enabled-user"
              } else{
                 title = "Inactive"
                 modal = "#Reactivate_Modal"
                 _Class = "fa fa-user-times disable-user"
              }
              let text = `<div class='action-btn'>
                          <a href="user/${row._id}">
                          <i data-toggle="tooltip" data-placement="top" title="View" class="fa fa-eye" aria-hidden="true"></i></a>
                          <a data-toggle="modal" data-target = "${modal}" data-id="${data}" data-status = "${row.isActive}">
                          <i data-toggle="tooltip" data-placement="top" title=${title} class="${_Class}" aria-hidden="true"></i></a>
                          </div>`
              return text
            }
         }
            ]
        })
    }
    </script>